#!/bin/bash

echo 
echo "   _  ______                    _____                     _      " 
echo "  | |/ /  _ \                  / ____|                   | |     " 
echo "  | ' /| |_) | __ _ ___  ___  | (___   ___  __ _ _ __ ___| |__   " 
echo "  |  < |  _ < / _' / __|/ _ \  \___ \ / _ \/ _' | '__/ __| '_ \  " 
echo "  | . \| |_) | (_| \__ \  __/  ____) |  __/ (_| | | | (__| | | | " 
echo "  |_|\_\____/ \__,_|___/\___| |_____/ \___|\__,_|_|  \___|_| |_| " 
echo 

log() {
  printf "  \033[36m%10s\033[0m : \033[90m%s\033[0m\n" $1 "$2"
}

alert() {
	printf "\n  \033[31mError: $@\033[0m\n\n" && exit 1
}


log starting "search service"
log setting environment

DEPLOYMENT=${DEPLOY-/kb/deployment}
RUNTIME=${RUNTIME-/kb/runtime}
CATALINA_HOME="$RUNTIME/tomcat"
export CATALINA_PID=/var/run/tomcat.pid


SERVICE="search"

export PATH=$JAVA_PATH/bin:$PATH
source $DEPLOYMENT/user-env.sh

log starting Tomcat
kill -0 $(cat $CATALINA_PID) > /dev/null 2> /dev/null
if [ $? -gt 0 ]
then
    $CATALINA_HOME/bin/startup.sh
else
    echo -n 'tomcat already running on pid: '
    cat $CATALINA_PID
fi

echo ;
log starting "Search service"
uwsgi --ini /kb/deployment/service/search/config/uwsgi_search.ini

log status "Service and Tomcat successfully started"
echo ;


