
var request    = require('request');
var _          = require('underscore');
var cdmiapi    = require('./apiEntity');

var KBaseServiceURL = 'http://kbase.us/services/cdmi_api';

var KBaseEntity = function( serviceURL ){

  var uri = serviceURL || KBaseServiceURL;

}

_.each(cdmiapi, function( apiCall, callName ) {
  KBaseEntity.prototype[callName] = makeOperation(apiCall);
});

function makeOperation( callDetails ) {

  var apiFunctionIdentifier = callDetails.source + '.' + callDetails.function;


  return function( args, _reqCallback, _reqErrorCallback ) {


    var options = { 'params' : [args]
      ,'method' : apiFunctionIdentifier
      ,'version': "1.1"
    };

    request({
        method: 'POST'
        , uri: KBaseServiceURL
        , body: JSON.stringify(options)
      }, function( error, response, body) {
          if(response.statusCode === 200){
            var result = JSON.parse(response.body);
            result = result["result"];
            _reqCallback(result[0]);
          } else {
            if (_reqErrorCallback)
            {
              _reqErrorCallback('error: ' + response.statusCode);

            } else {
              throw response.statusCode;
            }
          }
    });

   };
};

exports.KBaseEntity = KBaseEntity;
